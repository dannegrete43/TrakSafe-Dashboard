<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrakSafe Web - PPE Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800">PPE Inventory Management</h1>
            <p class="text-gray-500">Generate and export reports for your inventory and issuance logs.</p>
        </header>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-4">Export Reports</h2>
            <div class="grid md:grid-cols-2 gap-6">
                
                <!-- Card for Reorder Report -->
                <div class="bg-gray-50 p-6 rounded-lg border">
                    <h3 class="font-bold text-lg text-gray-800">Reorder List</h3>
                    <p class="text-gray-600 my-2">Generate a CSV file of all PPE items that are at or below their reorder threshold.</p>
                    <button id="exportReorderBtn" class="mt-4 w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                        Export Reorder List (.csv)
                    </button>
                </div>

                <!-- Card for Issuance Log Report -->
                <div class="bg-gray-50 p-6 rounded-lg border">
                    <h3 class="font-bold text-lg text-gray-800">Issuance Log</h3>
                    <p class="text-gray-600 my-2">Generate a complete CSV file of the PPE issuance log, tracking who each item was issued to.</p>
                    <button id="exportIssuanceBtn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                        Export Full Issuance Log (.csv)
                    </button>
                </div>

            </div>
        </div>
         <div id="loadingIndicator" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="text-white text-lg">Generating report...</div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace this with your project's actual Firebase configuration.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // --- Firebase Initialization ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const ppeInventoryCollection = db.collection("ppe-inventory");
        const issuanceLogCollection = db.collection("ppe-issuance-log");

        // --- DOM Elements ---
        const exportReorderBtn = document.getElementById('exportReorderBtn');
        const exportIssuanceBtn = document.getElementById('exportIssuanceBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // --- Event Listeners ---
        exportReorderBtn.addEventListener('click', handleExportReorderList);
        exportIssuanceBtn.addEventListener('click', handleExportIssuanceLog);

        // --- Helper Functions ---
        
        /**
         * A helper function to trigger a file download in the browser.
         * @param {string} filename - The name of the file to be downloaded.
         * @param {string} csvString - The CSV content as a string.
         */
        function downloadCSV(filename, csvString) {
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        /**
         * Shows or hides the loading indicator.
         * @param {boolean} show - Whether to show the indicator.
         */
        function setLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        // --- Main Logic ---

        /**
         * Fetches low-stock PPE items, converts them to CSV, and triggers a download.
         */
        async function handleExportReorderList() {
            setLoading(true);
            try {
                const snapshot = await ppeInventoryCollection.get();
                const allItems = snapshot.docs.map(doc => doc.data());
                
                // Filter for items that need reordering
                const itemsToReorder = allItems.filter(item => {
                    return item.quantity <= (item.reorderThreshold || 0);
                });

                if (itemsToReorder.length === 0) {
                    alert("No items currently need to be reordered.");
                    setLoading(false);
                    return;
                }

                // Generate CSV string
                let csvString = "SKU,Item Name,Description,Site,Current Quantity,Reorder Threshold\n";
                itemsToReorder.forEach(item => {
                    const sku = item.id || 'N/A';
                    const name = `"${item.name || ''}"`;
                    const description = `"${item.description || ''}"`;
                    const site = `"${item.site || ''}"`;
                    const quantity = item.quantity || 0;
                    const threshold = item.reorderThreshold || 0;
                    csvString += `${sku},${name},${description},${site},${quantity},${threshold}\n`;
                });

                const date = new Date().toISOString().slice(0, 10);
                downloadCSV(`PPE-Reorder-List-${date}.csv`, csvString);

            } catch (error) {
                console.error("Error generating reorder list:", error);
                alert("An error occurred while generating the report. Check the console for details.");
            } finally {
                setLoading(false);
            }
        }

        /**
         * Fetches the entire PPE issuance log, converts it to CSV, and triggers a download.
         */
        async function handleExportIssuanceLog() {
            setLoading(true);
            try {
                const snapshot = await issuanceLogCollection.orderBy("dateIssued", "desc").get();
                const logRecords = snapshot.docs.map(doc => doc.data());

                if (logRecords.length === 0) {
                    alert("The issuance log is empty.");
                    setLoading(false);
                    return;
                }
                
                // Generate CSV string
                let csvString = "Date Issued,SKU,Item Name,Quantity,Issued To,Site\n";
                logRecords.forEach(record => {
                    const date = record.dateIssued.toDate().toLocaleString();
                    const sku = record.ppeItemId || 'N/A';
                    const name = `"${record.ppeItemName || ''}"`;
                    const quantity = record.quantityIssued || 0;
                    const employee = `"${record.employeeName || ''}"`;
                    const site = `"${record.site || ''}"`;
                    csvString += `${date},${sku},${name},${quantity},${employee},${site}\n`;
                });
                
                const date = new Date().toISOString().slice(0, 10);
                downloadCSV(`PPE-Issuance-Log-${date}.csv`, csvString);

            } catch (error) {
                console.error("Error generating issuance log:", error);
                alert("An error occurred while generating the report. Check the console for details.");
            } finally {
                setLoading(false);
            }
        }

    </script>
</body>
</html>
