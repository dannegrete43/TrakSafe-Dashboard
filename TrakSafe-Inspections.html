<script type="module">
    // Import the things we need from our new auth.js file
    import { db, protectPage } from './js/auth.js'; 
    import { collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Run the security check FIRST!
    protectPage();

    // --- All of your existing page logic goes here ---
    let allInspections = [];
    const inspectionsList = document.getElementById('inspections-list');
    const loadingSpinner = document.getElementById('loading-spinner');
    const emptyState = document.getElementById('empty-state');
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    
    function getInspectionStatus(insp) {
        // ... (this function stays the same)
        if (insp.status) {
            let color = 'yellow';
            if (insp.status === 'Passed') color = 'green';
            if (insp.status === 'Failed') color = 'red';
            return { status: insp.status, color: color };
        }
        const isFailed = insp.extinguisherChanged === true || insp.nozzleObstructed === true || insp.physicalChanges === true || insp.pressureGaugeOK === false || insp.safetyPinIntact === false;
        if (isFailed) { return { status: 'Failed', color: 'red' }; }
        return { status: 'Passed', color: 'green' };
    }

    function renderInspections() {
        // ... (this function stays the same)
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const filtered = allInspections.filter(insp => {
            const calculatedStatus = getInspectionStatus(insp).status;
            const statusMatch = (statusValue === 'all' || calculatedStatus === statusValue);
            const searchMatch = !searchTerm || (insp.extinguisherId && insp.extinguisherId.toLowerCase().includes(searchTerm));
            return statusMatch && searchMatch;
        });
        inspectionsList.innerHTML = '';
        filtered.forEach(insp => {
            const date = insp.date ? insp.date.toDate().toLocaleString() : 'N/A';
            const { status, color } = getInspectionStatus(insp);
            let textColorClass = 'text-yellow-600';
            if (status === 'Passed') textColorClass = 'text-green-600';
            if (status === 'Failed') textColorClass = 'text-red-600';
            inspectionsList.innerHTML += `
                <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-${color}-500 mr-4"></div>
                        <div>
                            <p class="font-semibold">${insp.extinguisherId || 'N/A'}</p>
                            <p class="text-sm text-gray-500">${insp.site || 'No Site'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-semibold ${textColorClass}">${status}</p>
                        <p class="text-xs text-gray-500">${date}</p>
                    </div>
                </div>`;
        });
        emptyState.classList.toggle('hidden', filtered.length > 0);
    }

    function initialize() {
        // We removed the anonymous sign-in from here
        onSnapshot(query(collection(db, "inspections"), orderBy("date", "desc")), (snapshot) => {
            loadingSpinner.classList.add('hidden');
            allInspections = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderInspections();
        }, (error) => {
            loadingSpinner.classList.add('hidden');
            emptyState.innerHTML = '<p class="text-red-500">Error fetching data.</p>';
            emptyState.classList.remove('hidden');
        });
    }

    searchInput.addEventListener('input', renderInspections);
    statusFilter.addEventListener('change', renderInspections);
    window.onload = initialize;
</script>
